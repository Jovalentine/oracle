<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Oracle Forensic Report</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
<div class="container">

  <h1 class="title">ORACLE FORENSIC SYSTEM</h1>
  <p class="subtitle">AI-Assisted Accident Investigation Report</p>

  <div class="meta-box">
    {% set case_info = result.get('case', {}) %}
    <p><b>Case ID:</b> {{ case_info.get('case_id', result.get('case_id', 'Unknown')) }}</p>
    <p><b>Generated:</b> {{ case_info.get('generated_at', 'N/A') }}</p>
    <p class="disclaimer">{{ case_info.get('disclaimer', 'Legacy Data') }}</p>
  </div>

  <section class="card">
    <h2>1. Scene Reconstruction</h2>
    {% set scene = result.get('scene', {}) %}
    <p>{{ scene.get('summary', 'Summary unavailable') }}</p>

    <ul>
      <li><b>Collision Type:</b> {{ scene.get('collision_type', 'N/A') }}</li>
      <li><b>Collision Overlap (IoU):</b> {{ scene.get('collision_overlap', 'N/A') }}</li>
    </ul>
  </section>

  <section class="card">
    <h2>2. Identified Entities</h2>
    {% set entities = result.get('entities', {}) %}

    <h3>Vehicles</h3>
    <table>
      <tr>
        <th>ID</th>
        <th>Type</th>
        <th>Fault %</th>
        <th>Confidence Reasoning</th>
      </tr>
      {% for v in entities.get('vehicles', []) %}
      <tr>
        <td>{{ v.id }}</td>
        <td>{{ v.type }}</td>
        <td>{{ v.fault_percent }}%</td>
        <td>{{ v.confidence_reason }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4" class="muted">No vehicles detected</td></tr>
      {% endfor %}
    </table>

    {% if entities.get('persons') %}
    <h3>Persons</h3>
    <table>
      <tr>
        <th>ID</th>
        <th>Role</th>
        <th>Risk Level</th>
      </tr>
      {% for p in entities.get('persons', []) %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.role }}</td>
        <td>{{ p.risk_level }}</td>
      </tr>
      {% endfor %}
    </table>
    {% endif %}
  </section>

  <section class="card">
    <h2>3. Forensic Analysis</h2>
    {% set analysis = result.get('analysis', {}) %}
    {% set fault = analysis.get('fault_allocation', {}) %}
    {% set severity = analysis.get('severity', {}) %}
    {% set risks = analysis.get('risk_factors', {}) %}

    <p>
      <b>Primary Responsible Vehicle:</b>
      {{ fault.get('primary_vehicle', 'None') }}
    </p>

    <p>
      <b>Fault Reasoning Method:</b>
      {{ fault.get('method', 'N/A') }}
    </p>

    <h3>Accident Severity</h3>
    <p>
      <b>Score:</b> {{ severity.get('score', 0) }}/100<br>
      <b>Level:</b> {{ severity.get('level', 'N/A') }}
    </p>

    <ul>
      <li>Pedestrian Involved:
        {{ "Yes" if risks.get('pedestrian_involved') else "No" }}
      </li>
      <li>Multiple Vehicles:
        {{ "Yes" if risks.get('multi_vehicle') else "No" }}
      </li>
    </ul>

    {% set plates = analysis.get('license_plates') %}
    {% if plates %}
    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <h3 style="color: #00d2ff;">Detected License Plates</h3>
        <table>
          <tr>
            <th>Plate Number</th>
            <th>Confidence</th>
          </tr>
          {% for lp in plates %}
          <tr>
            <td><b style="color: #fff; font-family: monospace; font-size: 1.1em;">{{ lp.plate }}</b></td>
            <td>{{ lp.confidence }}</td>
          </tr>
          {% endfor %}
        </table>
    </div>
    {% endif %}

  </section>

  <div class="glass card fade-section">
    <h3 class="section-title">4. Visual Evidence</h3>
    {% set evidence = result.get('evidence', {}) %}

    {% if evidence.get('annotated_image') %}
      <img
        src="{{ url_for('view_image', filename=evidence.annotated_image) }}"
        alt="Annotated Forensic Evidence"
        class="forensic-image"
      >
      <p class="muted" style="margin-top:12px;">
        Annotated collision zones, vehicle identifiers, and entity markers
        generated by the Oracle Forensic AI.
      </p>
    {% else %}
      <p class="warning">
        Annotated visual evidence unavailable for this case.
      </p>
    {% endif %}
  </div>

  <section class="card">
    <h2>5. AI Narrative Reconstruction</h2>
    {% set narrative = result.get('narrative', {}) %}
    <p style="line-height:1.7">
      {{ narrative.get('reconstruction', 'Narrative unavailable') }}
    </p>
  </section>

  <section class="card">
    <h2>6. AI Investigative Explanation</h2>
    <p>{{ result.get('explanation', 'Explanation unavailable') }}</p>
  </section>

  <div class="actions">
    {% if case_info.get('case_id') %}
        <a class="btn" href="{{ url_for('download_pdf', case_id=case_info.case_id) }}">
          üìÑ Download PDF Report
        </a>
    {% endif %}
    
    <a class="btn secondary" href="{{ url_for('dashboard') }}">
      ‚Üê Back to Dashboard
    </a>
  </div>

</div>
</body>
</html>